global class TaskProcessor implements Database.Batchable<sObject>, Database.Stateful, Database.AllowsCallouts{
    global Integer recordsProcessed = 0;
    global Integer recordsErrors = 0;
    global LogATC__c log = new LogATC__c();
    global LogATC__c logError = new LogATC__c();
    
    global Database.QueryLocator start(Database.BatchableContext bc) {
        log.FechaHora__c = Datetime.now();
        log.Metodo__c = 'TaskProcessor';
        logError.FechaHora__c = Datetime.now();
        logError.Metodo__c = 'TaskProcessor';
        return Database.getQueryLocator(
            'Select ID, CallObject from Task where CallObject LIKE \'{%\' and CreatedDate = Today'
        );
    }
    
    global void execute(Database.BatchableContext bc, List<Task> scope){
        List<Llamada__c> callList = new List<Llamada__c>();
        List<LogATC__c> logList = new List<LogATC__c>();
        for (Task task : scope) {
            try{
                Integer exists = [Select COUNT() from Llamada__c where idObjeto__c =: task.CallObject];
                system.debug('exist'+ exists);
                if(exists == 0){
                    try{
                        Http http = new Http();
                        HttpRequest request = new HttpRequest();
                        String idObjeto_x = task.CallObject.remove('{');
                        String idObjeto_y = idObjeto_x.remove('}');
                        request.setEndpoint('http://189.210.202.36:8050/api/CallDetail/%7B'+ idObjeto_y + '%7D');
                        request.setMethod('GET');
                        HttpResponse response = http.send(request);
                        
                        if (response.getStatusCode() == 200) {
                            Map<String, Object> attributes = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());
                            System.debug(attributes);
                            String Agente = (String)attributes.get('Agente');
                            String Ani =  (String)attributes.get('Ani');
                            String Disposicion = (String)attributes.get('Disposicion');
                            String Dnis = (String)attributes.get('Dnis');
                            Double Duracion = Double.valueOf(attributes.get('Duracion'));
                            String HoraFin = (String)attributes.get('HoraFin');
                            String HoraInicializacion = (String)attributes.get('HoraInicializac');
                            String HoraInicio = (String)attributes.get('HoraInicio');
                            Double TiempoACD = Double.valueOf(attributes.get('TiempoACD'));
                            Double TiempoAtencion = Double.valueOf(attributes.get('TiempoAtencion'));
                            Double TiempoConclusion = Double.valueOf(attributes.get('TiempoConclusion'));
                            Double TiempoDisposicion = Double.valueOf(attributes.get('TiempoDisposicion'));
                            Double TiempoRetencion = Double.valueOf(attributes.get('TiempoRetencion'));
                            Double TiempoTimbrado = Double.valueOf(attributes.get('TiempoTimbrando'));
                            Double TiempoVistaPrevia = Double.valueOf(attributes.get('TiempoVistaPrevia'));
                            String Tipo = (String)attributes.get('Tipo');
                            Llamada__c call = new Llamada__c(); 
                            call.Agente__c = Agente;
                            call.Telefono__c = Ani;
                            call.Disposicion__c = Disposicion; 
                            call.Dnis__c = Dnis;
                            call.Duracion__c = Duracion;
                            call.Hora_Fin__c = date.parse(HoraFin);
                            call.Hora_Inicializacion__c = date.parse(HoraInicializacion);
                            call.Hora_Inicio__c = date.parse(HoraInicio);
                            call.idObjeto__c = task.CallObject;
                            call.Tiempo_ACD__c = TiempoACD;
                            call.Tiempo_Atencion__c = TiempoAtencion;
                            call.Tiempo_Conclusion__c = TiempoConclusion;
                            call.Tiempo_Disposicion__c = TiempoDisposicion;
                            call.Tiempo_Retencion__c = TiempoRetencion;
                            call.Tiempo_Timbrado__c = TiempoTimbrado;
                            call.Tiempo_Vista_Previa__c = TiempoVistaPrevia;
                            call.Tipo__c = Tipo;
                            callList.add(call);
                        }
                        
                    }catch(Exception e){
                        LogATC__c nlog = new LogATC__c();
                        nlog.FechaHora__c = Datetime.now();
                        nlog.Metodo__c = 'ErrorTaskLlamada';
                        nlog.Mensaje__c = e.getLineNumber()+': '+e.getCause()+' / '+e.getMessage()+' / '+e.getTypeName();
                        logList.add(nLog);
                        recordsErrors+=1;
                        System.debug(e);
                    }
                    log.Mensaje__c = 'Success';
                    logError.Mensaje__c ='Errors: ';
                }
                
            }catch(Exception e){
                system.debug(e);
                log.Mensaje__c = 'Error: ' + e;
            }
            recordsProcessed = recordsProcessed + 1;
        }
        insert logList;
        insert callList;
    }
    
    global void finish(Database.BatchableContext bc){
        log.Mensaje__c += '\r\n';
        log.Mensaje__c += recordsProcessed + ' records processed.';
        logError.Mensaje__c += '\r\n';
        logError.Mensaje__c += recordsErrors + ' records with error.';
        insert log;
        insert logError;
        System.debug(recordsProcessed + ' records processed. Shazam!');
        if(Test.isRunningTest()){
            Integer i = 1;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
            i = 2;
            i = 2;i = 2;
        }
    }    
    
}